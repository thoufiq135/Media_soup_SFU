const express=require("express")
const mediasoup=require("mediasoup")
const cors=require("cors")
const {Server}=require("socket.io")
const http=require("http")
const { error } = require("console")
const app=express()
app.use(cors())

app.use(express.json())
const server= http.createServer(app)
const consumers = new Map();

const io=new Server(server,{
path: "/socket.io",
    cors:{
        origin:"https://gsin.online",
        methods:["GET","POST"],
        credentials:true
    },
    transports:["polling","websocket"],
 allowEIO3: true
})
let workers;
const mediaCodecs=[
    {kind:"audio",mimeType:"audio/opus",clockRate:48000,channels:2},
    {kind:"video",mimeType:"video/VP8",clockRate:90000}
]

const rooms={
    room1:{router:null,producers:[], users:[], max:25},
    room0:{ router:null,producers:[], users:[],max:4},
    room2:{ router:null,producers:[], users:[],max:4},
    room3:{ router:null,producers:[], users:[],max:4},
    room4:{ router:null,producers:[], users:[],max:4},
    room5:{ router:null,producers:[], users:[],max:4},
    room6:{ router:null,producers:[], users:[],max:4},
    room7:{ router:null,producers:[], users:[],max:4},
    room8:{ router:null,producers:[], users:[],max:4},
}
async function startMediaSoup(){
    workers=await mediasoup.createWorker()
    console.log("worker created")
    for(const roomid in rooms){
    rooms[roomid].router=await workers.createRouter({mediaCodecs})
    console.log(`room id created for roomid ${roomid} : ${rooms[roomid].router.id}`)

}
}
startMediaSoup()
io.on("connection",socket=>{
    console.log("user connected = ",socket.id)
    socket.on("joinRoom",({roomid},cb)=>{
        console.log("came to joinRoom") 
    })
    socket.on("createTransport",async(cb)=>{
        console.log("camr to createTransport")
    })
    socket.on("connectTransport",async({dtlsParameters})=>{
      
        console.log("came to connectTransport")
    })
    socket.on("produce",async ({kind,rtpParameters},cb)=>{
console.log("came to produce")
})
    socket.on("createRecvTransport", async (cb) => {

  console.log("cam to createRecvTransport")

});
socket.on("connectRecvTransport", async ({ dtlsParameters }) => {
  console.log("came to connectRecvTransport")
});
socket.on("consume", async ({ producerId, rtpCapabilities }, cb) => {
 console.log("came to consume")
});
socket.on("resumeConsumer", async ({consumerId}) => {
    
  console.log("came to resumeConsumer");
});
    socket.on("leaveRoom", () => {

  console.log("came to le
});

    socket.on("disconnect",()=>{
        const room = rooms[socket.roomid];
    if (!room) return;

    // Remove user
    room.users = room.users.filter(id => id !== socket.id);

    // Remove their producers
    if (socket.producers) {
        socket.producers.forEach(p => {
            room.producers = room.producers.filter(rp => rp.id !== p.id);
            p.close();
        });
    }

    console.log("User disconnected:", socket.id);
    })
})
server.listen(3030,"0.0.0.0",()=>{
    console.log("server is running on port 3030")
});
